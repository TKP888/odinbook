<div class="container-fluid">
  <div class="row">
    <!-- Profile Header -->
    <div class="col-12 mb-4">
      <div class="card profile-header-card">
        <div class="card-body text-center py-5">
          <div class="profile-avatar mb-4">
            <div class="profile-picture-container">
              <div class="user-avatar-large profile-picture" id="profilePicture">
                <% if (typeof profileUser !== 'undefined') { %>
                  <% if (profileUser.useGravatar && profileUser.email) { %>
                    <img src="<%= getGravatarUrl(profileUser.email, 200) %>" alt="Profile Picture" class="profile-image">
                  <% } else if (profileUser.profilePicture && (profileUser.profilePicture.startsWith('http') || profileUser.profilePicture.startsWith('/uploads/') || profileUser.profilePicture.includes('cloudinary.com') || profileUser.profilePicture.includes('gravatar.com'))) { %>
                    <img src="<%= profileUser.profilePicture %>" alt="Profile Picture" class="profile-image">
                  <% } else { %>
                    <%= profileUser.firstName.charAt(0) %><%= profileUser.lastName.charAt(0) %>
                  <% } %>
                <% } else { %>
                  <% if (user.useGravatar && user.email) { %>
                    <img src="<%= getGravatarUrl(user.email, 200) %>" alt="Profile Picture" class="profile-image">
                  <% } else if (user.profilePicture && (user.profilePicture.startsWith('http') || user.profilePicture.startsWith('/uploads/') || user.profilePicture.includes('cloudinary.com') || user.profilePicture.includes('gravatar.com'))) { %>
                    <img src="<%= user.profilePicture %>" alt="Profile Picture" class="profile-image">
                  <% } else { %>
                    <%= user.firstName.charAt(0) %><%= user.lastName.charAt(0) %>
                  <% } %>
                <% } %>
              </div>
              <% if (typeof profileUser === 'undefined') { %>
                <div class="profile-picture-overlay">
                  <label for="profilePictureInput" class="profile-picture-upload-btn">
                    <i class="fas fa-camera"></i>
                    <span>Change Photo</span>
                  </label>
                  <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                </div>
              <% } %>
            </div>
          </div>
          <h1 class="profile-name mb-2">
            <% if (typeof profileUser !== 'undefined') { %>
              <%= profileUser.firstName %> <%= profileUser.lastName %>
            <% } else { %>
              <%= user.firstName %> <%= user.lastName %>
            <% } %>
          </h1>
          <p class="profile-username mb-4">
            @<% if (typeof profileUser !== 'undefined') { %><%= profileUser.username %><% } else { %><%= user.username %><% } %>
          </p>
          
          <% if (typeof profileUser === 'undefined') { %>
            <!-- Current user's profile - show edit button -->
            <button class="btn btn-primary btn-lg" onclick="openEditProfileModal()">
              <i class="fas fa-edit me-2"></i>Edit Profile
            </button>
          <% } else { %>
            <!-- Other user's profile - show friend actions -->
            <% if (isFriend) { %>
              <button class="btn btn-success btn-lg me-2" disabled>
                <i class="fas fa-user-check me-2"></i> Friends
              </button>
              <button
                class="btn btn-outline-danger btn-lg"
                onclick="removeFriend('<%= profileUser.id %>', '<%= profileUser.firstName %> <%= profileUser.lastName %>')"
              >
                <i class="fas fa-user-minus me-2"></i> Unfriend
              </button>
            <% } else if (pendingRequest) { %>
              <% if (pendingRequest.senderId === user.id) { %>
                <button class="btn btn-secondary btn-lg" disabled>
                  <i class="fas fa-clock me-2"></i> Request Sent
                </button>
              <% } else { %>
                <div class="btn-group btn-group-lg" role="group">
                  <button class="btn btn-success" onclick="acceptRequest('<%= pendingRequest.id %>')">
                    <i class="fas fa-check me-2"></i> Accept
                  </button>
                  <button class="btn btn-outline-secondary" onclick="declineRequest('<%= pendingRequest.id %>')">
                    <i class="fas fa-times me-2"></i> Decline
                  </button>
                </div>
              <% } %>
            <% } else { %>
              <button class="btn btn-primary btn-lg" onclick="sendFriendRequest('<%= profileUser.id %>', '<%= profileUser.firstName %> <%= profileUser.lastName %>')">
                <i class="fas fa-user-plus me-2"></i> Add Friend
              </button>
            <% } %>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Main Content Row -->
    <div class="col-12">
      <div class="row">
        <!-- About Section -->
        <div class="col-lg-8 mb-4">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>About
              </h5>
            </div>
            <div class="card-body">
              <!-- Bio Display -->
              <div id="bio-display">
                <% 
                  const displayUser = typeof profileUser !== 'undefined' ? profileUser : user;
                  const displayBio = displayUser.bio;
                %>
                <% if (displayBio) { %>
                  <p class="bio-text mb-3"><%= displayBio %></p>
                  <% if (typeof profileUser === 'undefined') { %>
                    <button class="btn btn-outline-primary btn-sm" onclick="editBio()">
                      <i class="fas fa-edit me-1"></i> Edit Bio
                    </button>
                  <% } %>
                <% } else { %>
                  <p class="text-muted mb-3">No bio added yet.</p>
                  <% if (typeof profileUser === 'undefined') { %>
                    <button class="btn btn-outline-primary btn-sm" onclick="editBio()">
                      <i class="fas fa-plus me-1"></i> Add Bio
                    </button>
                  <% } %>
                <% } %>
              </div>
              
              <!-- Bio Edit Form (hidden by default, only for current user) -->
              <% if (typeof profileUser === 'undefined') { %>
                <div id="bio-edit" class="d-none">
                  <div class="mb-3">
                    <textarea
                      id="bioTextarea"
                      class="form-control"
                      rows="4"
                      placeholder="Tell us about yourself..."
                      maxlength="250"
                    ><%= user.bio || '' %></textarea>
                    <div class="form-text text-end">
                      <span id="bioCharCount"><%= (user.bio || '').length %></span>/250
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm" onclick="saveBio()">
                      <i class="fas fa-save me-1"></i> Save
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="cancelBioEdit()">
                      <i class="fas fa-times me-1"></i> Cancel
                    </button>
                  </div>
                </div>
              <% } %>
              
              <!-- Profile Information -->
              <div class="profile-info mt-4">
                <h6 class="text-muted mb-3">Profile Information</h6>
                
                <!-- Joined Date -->
                <div class="info-item d-flex align-items-center mb-2">
                  <i class="fas fa-calendar-alt me-2 text-muted"></i>
                  <span class="text-muted">Joined </span>
                  <span class="ms-1">
                    <% 
                      const joinedDate = displayUser.createdAt;
                      const options = { year: 'numeric', month: 'long' };
                      const formattedDate = new Date(joinedDate).toLocaleDateString('en-US', options);
                    %>
                    <%= formattedDate %>
                  </span>
                </div>
                
                <!-- Birthday -->
                <% if (displayUser.birthday) { %>
                  <div class="info-item d-flex align-items-center mb-2">
                    <i class="fas fa-birthday-cake me-2 text-muted"></i>
                    <span class="text-muted">Birthday: </span>
                    <span class="ms-1">
                      <% 
                        const birthday = new Date(displayUser.birthday);
                        const birthdayOptions = { month: 'long', day: 'numeric', year: 'numeric' };
                        const formattedBirthday = birthday.toLocaleDateString('en-US', birthdayOptions);
                      %>
                      <%= formattedBirthday %>
                    </span>
                  </div>
                <% } %>
                
                <!-- Gender -->
                <% if (displayUser.gender) { %>
                  <div class="info-item d-flex align-items-center mb-2">
                    <i class="fas fa-user me-2 text-muted"></i>
                    <span class="text-muted">Gender: </span>
                    <span class="ms-1"><%= displayUser.gender %></span>
                  </div>
                <% } %>
                
                <!-- Location -->
                <% if (displayUser.location) { %>
                  <div class="info-item d-flex align-items-center mb-2">
                    <i class="fas fa-map-marker-alt me-2 text-muted"></i>
                    <span class="text-muted">Location: </span>
                    <span class="ms-1"><%= displayUser.location %></span>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Friends Section -->
        <div class="col-lg-4 mb-4">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-users me-2"></i>
                <% if (typeof profileUser !== 'undefined') { %>
                  <%= profileUser.firstName %>'s Friends
                <% } else { %>
                  Your Friends
                <% } %>
              </h5>
            </div>
            <div class="card-body">
              <% if (typeof profileUser !== 'undefined' && !isFriend) { %>
              <!-- Not Friends - Show Restricted Message -->
              <div class="text-center text-muted py-4">
                <i class="fas fa-lock fa-3x mb-3 text-warning"></i>
                <h6>Friends are Private</h6>
                <p class="small">Become friends with <%= profileUser.firstName %> to see their friends!</p>
                <div class="mt-3">
                  <small class="text-muted">
                    <i class="fas fa-users me-1"></i>
                    <%= profileUser.firstName %> has friends, but you need to connect first to see them.
                  </small>
                </div>
                <% if (!pendingRequest) { %>
                  <button class="btn btn-primary btn-sm mt-3" onclick="sendFriendRequest('<%= profileUser.id %>', '<%= profileUser.firstName %> <%= profileUser.lastName %>')">
                    <i class="fas fa-user-plus me-1"></i> Send Friend Request
                  </button>
                <% } else if (pendingRequest.senderId === user.id) { %>
                  <button class="btn btn-secondary btn-sm mt-3" disabled>
                    <i class="fas fa-clock me-1"></i> Request Sent
                  </button>
                <% } else { %>
                  <div class="btn-group btn-group-sm mt-3" role="group">
                    <button class="btn btn-success" onclick="acceptRequest('<%= pendingRequest.id %>')">
                      <i class="fas fa-check me-1"></i> Accept
                    </button>
                    <button class="btn btn-outline-secondary" onclick="declineRequest('<%= pendingRequest.id %>')">
                      <i class="fas fa-times me-1"></i> Decline
                    </button>
                  </div>
                <% } %>
              </div>
              <% } else if (friends.length === 0) { %>
              <div class="text-center text-muted py-4">
                <i class="fas fa-users fa-3x mb-3 text-muted"></i>
                <h6>No friends yet</h6>
                <p class="small">
                  <% if (typeof profileUser === 'undefined') { %>
                    Start connecting with people to build your network!
                  <% } else { %>
                    <%= profileUser.firstName %> hasn't added any friends yet.
                  <% } %>
                </p>
                <% if (typeof profileUser === 'undefined') { %>
                  <button class="btn btn-primary btn-sm" onclick="switchToAllUsers()">
                    <i class="fas fa-search me-1"></i> Find Friends
                  </button>
                <% } %>
              </div>
              <% } else { %>
              <div class="friends-list">
                <% friends.slice(0, 5).forEach(friend => { %>
                <div class="friend-item d-flex align-items-center mb-3 p-3 border rounded">
                  <div class="user-avatar-small me-3">
                    <% if (friend.useGravatar && friend.email) { %>
                      <img src="<%= getGravatarUrl(friend.email, 200) %>" alt="Profile Picture" class="profile-image">
                    <% } else if (friend.profilePicture && (friend.profilePicture.startsWith('http') || friend.profilePicture.startsWith('/uploads/') || friend.profilePicture.includes('cloudinary.com'))) { %>
                      <img src="<%= friend.profilePicture %>" alt="Profile Picture" class="profile-image">
                    <% } else { %>
                      <%= (friend.firstName || '').charAt(0) %><%= (friend.lastName || '').charAt(0) %>
                    <% } %>
                  </div>
                  <div class="flex-grow-1">
                    <h6 class="mb-1 small">
                      <a href="/profile/<%= friend.id %>" class="text-decoration-none">
                        <%= friend.firstName || '' %> <%= friend.lastName || '' %> <%
                        if (!friend.firstName && !friend.lastName) { %>
                        <span class="text-muted">(No name)</span>
                        <% } %>
                      </a>
                    </h6>
                    <p class="text-muted mb-0 small">@<%= friend.username %></p>
                  </div>
                  <% if (typeof profileUser === 'undefined') { %>
                    <button
                      class="btn btn-outline-danger btn-sm remove-friend-btn"
                      data-friend-id="<%= friend.id %>"
                      data-friend-name="<%= friend.firstName || 'No First Name' %> <%= friend.lastName || 'No Last Name' %>"
                      title="Unfriend"
                    >
                      <i class="fas fa-user-minus"></i>
                    </button>
                  <% } %>
                </div>
                <% }); %> <% if (friends.length > 5) { %>
                <div class="text-center mt-3">
                  <button class="btn btn-outline-primary btn-sm" onclick="openViewAllFriendsModal()">
                    <i class="fas fa-eye me-1"></i> View All <%= friends.length %> Friends
                  </button>
                </div>
                <% } %>
              </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% if (typeof profileUser === 'undefined') { %>
  <!-- Create Post Form - only show for current user -->
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-edit me-2"></i>Create New Post
        </h6>
      </div>
      <div class="card-body">
        <div class="d-flex align-items-start">
          <div class="user-avatar-small me-3 flex-shrink-0">
            <% if (user.useGravatar && user.email) { %>
              <img src="<%= getGravatarUrl(user.email, 200) %>" alt="Profile Picture" class="profile-image">
            <% } else if (user.profilePicture && (user.profilePicture.startsWith('http') || user.profilePicture.startsWith('/uploads/') || user.profilePicture.includes('cloudinary.com'))) { %>
              <img src="<%= user.profilePicture %>" alt="Profile Picture" class="profile-image">
            <% } else { %>
              <%= user.firstName.charAt(0) %><%= user.lastName.charAt(0) %>
            <% } %>
          </div>
          <div class="flex-grow-1">
            
            <form id="inlineCreatePostForm" enctype="multipart/form-data">
              <div class="mb-3">
                <textarea
                  id="inlinePostContent"
                  class="form-control"
                  rows="3"
                  placeholder="What's on your mind, <%= user.firstName %>?"
                  maxlength="250"
                ></textarea>
              </div>
              
              <!-- Photo upload section -->
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                  <input
                    type="file"
                    id="inlinePostPhoto"
                    name="photo"
                    accept="image/*"
                    class="form-control form-control-sm"
                    style="display: none"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm me-2"
                    onclick="document.getElementById('inlinePostPhoto').click()"
                  >
                    <i class="fas fa-camera me-1"></i> Add Photo
                  </button>
                  <span
                    id="inlinePhotoFileName"
                    class="text-muted small me-2"
                  ></span>
                  <button
                    type="button"
                    id="inlineRemovePhotoBtn"
                    class="btn btn-outline-danger btn-sm"
                    style="display: none"
                    onclick="removeInlinePhoto()"
                  >
                    <i class="fas fa-times me-1"></i> Remove
                  </button>
                </div>
                
                <div class="d-flex align-items-center">
                  <small class="text-muted me-3">
                    <span id="inlineCharCount">0</span>/250
                  </small>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="createInlinePost()"
                    id="inlineCreatePostBtn"
                  >
                    <i class="fas fa-paper-plane me-1"></i> Post
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
<% } %>

<!-- Posts Feed -->
<div class="col-12">
  <div class="card">
                <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-newspaper me-2"></i>
                <% if (typeof profileUser !== 'undefined') { %>
                  <%= profileUser.firstName %>'s Posts
                <% } else { %>
                  My Posts
                <% } %>
              </h5>
            </div>
    <div class="card-body">
      <% if (typeof profileUser !== 'undefined' && !isFriend) { %>
      <!-- Not Friends - Show Restricted Message -->
      <div class="text-center text-muted py-5">
        <i class="fas fa-lock fa-3x mb-3 text-warning"></i>
        <h5>Posts are Private</h5>
        <p class="text-muted">Become friends with <%= profileUser.firstName %> to see their posts!</p>
        <div class="mt-3">
          <small class="text-muted">
            <i class="fas fa-newspaper me-1"></i>
            <%= profileUser.firstName %> has shared posts, but you need to connect first to see them.
          </small>
        </div>
        <% if (!pendingRequest) { %>
          <button class="btn btn-primary mt-3" onclick="sendFriendRequest('<%= profileUser.id %>', '<%= profileUser.firstName %> <%= profileUser.lastName %>')">
            <i class="fas fa-user-plus me-1"></i> Send Friend Request
          </button>
        <% } else if (pendingRequest.senderId === user.id) { %>
          <button class="btn btn-secondary mt-3" disabled>
            <i class="fas fa-clock me-1"></i> Friend Request Sent
          </button>
        <% } else { %>
          <div class="btn-group mt-3" role="group">
            <button class="btn btn-success" onclick="acceptRequest('<%= pendingRequest.id %>')">
              <i class="fas fa-check me-1"></i> Accept Request
            </button>
            <button class="btn btn-outline-secondary" onclick="declineRequest('<%= pendingRequest.id %>')">
              <i class="fas fa-times me-1"></i> Decline
            </button>
          </div>
        <% } %>
      </div>
      <% } else if (posts.length === 0) { %>
      <!-- No Posts -->
      <div class="text-center text-muted py-5">
        <i class="fas fa-newspaper fa-3x mb-3"></i>
        <h5>No posts yet</h5>
        <p class="text-muted">Share your thoughts with the world!</p>
        <% if (typeof profileUser === 'undefined') { %>
          <button class="btn btn-primary" onclick="openCreatePostModal()">
            <i class="fas fa-plus me-1"></i> Create Post
          </button>
        <% } %>
      </div>
      <% } else { %>
      <!-- Posts List -->
      <div class="posts-list">
        <% posts.forEach(post => { %>
        <div class="post-item mb-4 p-4 border rounded shadow-sm" data-post-id="<%= post.id %>">
            <!-- Post Header -->
            <div class="d-flex align-items-start mb-3">
              <div class="user-avatar-small me-3">
                <% if (post.user.useGravatar && post.user.email) { %>
                  <img src="<%= getGravatarUrl(post.user.email, 200) %>" alt="Profile Picture" class="profile-image">
                <% } else if (post.user.profilePicture && (post.user.profilePicture.startsWith('http') || post.user.profilePicture.startsWith('/uploads/') || post.user.profilePicture.includes('cloudinary.com'))) { %>
                  <img src="<%= post.user.profilePicture %>" alt="Profile Picture" class="profile-image">
                <% } else { %>
                  <%= (post.user.firstName || '').charAt(0) %><%= (post.user.lastName || '').charAt(0) %>
                <% } %>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="mb-1">
                      <a href="/profile/<%= post.user.id %>" class="text-decoration-none fw-bold text-primary">
                        <%= post.user.firstName || '' %> <%= post.user.lastName || '' %>
                      </a>
                    </h6>
                    <div class="d-flex align-items-center gap-2">
                      <small class="text-muted">
                        <a href="/profile/<%= post.user.id %>" class="text-decoration-none text-muted">@<%= post.user.username %></a>
                      </small>
                      <small class="text-muted">•</small>
                      <small class="text-muted">
                        <%= new Date(post.createdAt).toLocaleDateString() %> at <%= new Date(post.createdAt).toLocaleTimeString() %>
                      </small>
                    </div>
                  </div>
                  <% if (typeof profileUser === 'undefined' && post.userId === user.id) { %>
                    <div class="dropdown">
                      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-h"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item edit-post-btn" href="#" data-post-id="<%= post.id %>" data-post-content="<%= post.content.replace(/'/g, "\\'") %>">
                          <i class="fas fa-edit me-2"></i> Edit
                        </a></li>
                        <li><a class="dropdown-item text-danger delete-post-btn" href="#" data-post-id="<%= post.id %>">
                          <i class="fas fa-trash me-2"></i> Delete
                        </a></li>
                      </ul>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>

            <!-- Post Content -->
            <div class="post-content">
              <p><%= post.content.replace(/\n/g, "<br>") %></p>
              
              <!-- Post Image -->
              <% if (post.photoUrl) { %>
                <div class="post-photo">
                  <img src="<%= post.photoUrl %>" alt="Post image" class="img-fluid rounded" style="max-width: 100%; max-height: 600px; height: auto; object-fit: contain;">
                </div>
              <% } %>
            </div>

            <!-- Post Actions -->
            <div class="d-flex justify-content-between align-items-center pt-3 border-top">
              <!-- Action Buttons -->
              <div class="d-flex gap-2">
                <!-- Like Button -->
                <button class="btn btn-sm like-btn <%= post.likes.some(like => like.userId === user.id) ? 'liked' : 'btn-outline-primary' %>" 
                        id="like-btn-<%= post.id %>"
                        onclick="toggleLike('<%= post.id %>')" 
                        data-post-id="<%= post.id %>">
                  <i class="fas fa-heart"></i> 
                  Like
                </button>
                
                <!-- Comment Button -->
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleComments('<%= post.id %>')">
                  <i class="fas fa-comment"></i> 
                  Comment
                </button>
              </div>
              
              <!-- Counters -->
              <div class="text-muted small">
                <span class="likes-count" onclick="showLikes('<%= post.id %>')">
                  <%= post.likes.length %> like<%= post.likes.length !== 1 ? 's' : '' %>
                </span>
                <span class="comments-count ms-2" onclick="toggleComments('<%= post.id %>')">
                  <%= post.comments.length %> comment<%= post.comments.length !== 1 ? 's' : '' %>
                </span>
              </div>
            </div>

            <!-- Comments Section -->
            <div class="comments-section mt-3 d-none" id="comments-<%= post.id %>">
              <div class="comments-list mb-3" id="comments-list-<%= post.id %>">
                <% if (post.comments && post.comments.length > 0) { %>
                  <% post.comments.forEach(comment => { %>
                  <div class="comment-item p-3 border-bottom" data-comment-id="<%= comment.id %>">
                    <div class="d-flex align-items-start">
                      <div class="user-avatar-tiny me-2">
                        <% if (comment.user.useGravatar && comment.user.email) { %>
                          <img src="<%= getGravatarUrl(comment.user.email, 200) %>" alt="Profile Picture" class="profile-image">
                        <% } else if (comment.user.profilePicture && (comment.user.profilePicture.startsWith('http') || comment.user.profilePicture.startsWith('/uploads/') || comment.user.profilePicture.includes('cloudinary.com'))) { %>
                          <img src="<%= comment.user.profilePicture %>" alt="Profile Picture" class="profile-image">
                        <% } else { %>
                          <%= (comment.user.firstName || '').charAt(0) %><%= (comment.user.lastName || '').charAt(0) %>
                        <% } %>
                      </div>
                      <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <small class="fw-bold">
                              <a href="/profile/<%= comment.user.id %>" class="text-decoration-none">
                                <%= comment.user.firstName || '' %> <%= comment.user.lastName || '' %>
                              </a>
                            </small>
                            <div class="comment-content mt-1"><%= comment.content %></div>
                            <small class="text-muted"><%= new Date(comment.createdAt).toLocaleDateString() %></small>
                          </div>
                          <% if (comment.userId === user.id) { %>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-sm btn-outline-primary" onclick="editComment('<%= comment.id %>', '<%= post.id %>', '<%= comment.content %>')" title="Edit comment">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteComment('<%= comment.id %>')" title="Delete comment">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                          <% } %>
                        </div>
                      </div>
                    </div>
                  </div>
                  <% }); %>
                <% } else { %>
                  <p class="text-muted text-center">No comments yet</p>
                <% } %>
              </div>
              <div class="comment-form">
                <div class="input-group">
                  <input type="text" class="form-control form-control-sm" placeholder="Write a comment..." id="comment-input-<%= post.id %>" onkeypress="handleCommentKeyPress(event, '<%= post.id %>')">
                  <button class="btn btn-primary btn-sm" onclick="submitComment('<%= post.id %>')">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        <% }); %>
      </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Edit Comment Modal -->
<div
  class="modal fade"
  id="editCommentModal"
  tabindex="-1"
  aria-labelledby="editCommentModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCommentModalLabel">Edit Comment</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="editCommentForm">
          <input type="hidden" id="editCommentId" />
          <div class="mb-3">
            <textarea
              id="editCommentContent"
              class="form-control"
              rows="4"
              placeholder="Edit your comment..."
              maxlength="250"
            ></textarea>
            <div class="form-text">
              <span id="editCommentCharCount">0</span>/250
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveEditedComment()"
          id="saveEditCommentBtn"
        >
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<script src="/js/profile.js"></script>

<!-- Create Post Modal -->
<div
  class="modal fade"
  id="createPostModal"
  tabindex="-1"
  aria-labelledby="createPostModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createPostModalLabel">
          Create New Post
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="createPostForm" enctype="multipart/form-data">
          <div class="mb-3">
            <textarea
              id="postContent"
              class="form-control"
              rows="6"
              placeholder="What's on your mind, <%= user.firstName.charAt(0) %>?"
              maxlength="250"
            ></textarea>
            
            <!-- Photo upload section -->
            <div class="mt-2">
              <input
                type="file"
                id="postPhoto"
                name="photo"
                accept="image/*"
                class="form-control form-control-sm"
                style="display: none"
              />
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm me-2"
                onclick="document.getElementById('postPhoto').click()"
              >
                <i class="fas fa-camera"></i> Add Photo
              </button>
              <span
                id="photoFileName"
                class="text-muted small"
              ></span>
              <button
                type="button"
                id="removePhotoBtn"
                class="btn btn-outline-danger btn-sm ms-2"
                style="display: none"
                onclick="removePhoto()"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="form-text"><span id="charCount">0</span>/250</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="createPost()"
          id="createPostBtn"
        >
          Post
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Post Modal -->
<div
  class="modal fade"
  id="editPostModal"
  tabindex="-1"
  aria-labelledby="editPostModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPostModalLabel">Edit Post</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="editPostForm">
          <input type="hidden" id="editPostId" />
          <div class="mb-3">
            <textarea
              id="editPostContent"
              class="form-control"
              rows="6"
              placeholder="What's on your mind?"
              maxlength="1000"
            ></textarea>
            <div class="form-text">
              <span id="editCharCount">0</span>/250
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveEditedPost()"
          id="saveEditPostBtn"
        >
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Likes Modal -->
<div
  class="modal fade"
  id="likesModal"
  tabindex="-1"
  aria-labelledby="likesModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="likesModalLabel">
          People who liked this post
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="likesList">
          <!-- Likes will be populated here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div
  class="modal fade"
  id="editProfileModal"
  tabindex="-1"
  aria-labelledby="editProfileModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="editProfileForm">
          <div class="mb-3">
            <label for="editFirstName" class="form-label">First Name</label>
            <input
              type="text"
              class="form-control"
              id="editFirstName"
              value="<%= user.firstName %>"
              maxlength="50"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editLastName" class="form-label">Last Name</label>
            <input
              type="text"
              class="form-control"
              id="editLastName"
              value="<%= user.lastName %>"
              maxlength="50"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editUsername" class="form-label">Username</label>
            <input
              type="text"
              class="form-control"
              id="editUsername"
              value="<%= user.username %>"
              maxlength="30"
              minlength="3"
              required
            />
            <div class="form-text">Username must be between 3 and 30 characters</div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editBirthday" class="form-label">Birthday (Optional)</label>
              <input
                type="date"
                class="form-control"
                id="editBirthday"
                value="<%= user.birthday ? user.birthday.toISOString().split('T')[0] : '' %>"
              />
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="editGender" class="form-label">Gender (Optional)</label>
              <select class="form-control" id="editGender">
                <option value="">Select gender</option>
                <option value="Male" <%= user.gender === 'Male' ? 'selected' : '' %>>Male</option>
                <option value="Female" <%= user.gender === 'Female' ? 'selected' : '' %>>Female</option>
                <option value="Other" <%= user.gender === 'Other' ? 'selected' : '' %>>Other</option>
                <option value="Prefer not to say" <%= user.gender === 'Prefer not to say' ? 'selected' : '' %>>Prefer not to say</option>
              </select>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="editLocation" class="form-label">Location (Optional)</label>
            <input
              type="text"
              class="form-control"
              id="editLocation"
              value="<%= user.location || '' %>"
              placeholder="City, Country (e.g., London, UK)"
              maxlength="100"
            />
          </div>
          

        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveProfileChanges()"
          id="saveProfileBtn"
        >
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View All Friends Modal -->
<div
  class="modal fade"
  id="viewAllFriendsModal"
  tabindex="-1"
  aria-labelledby="viewAllFriendsModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewAllFriendsModalLabel">
          <i class="fas fa-users me-2"></i>All Friends (<%= friends.length %>)
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <% if (friends.length === 0) { %>
          <div class="text-center text-muted py-4">
            <i class="fas fa-users fa-3x mb-3 text-muted"></i>
            <h6>No friends yet</h6>
            <p class="text-muted">Start connecting with people to build your network!</p>
            <button class="btn btn-primary btn-sm" onclick="window.location.href='/friends/users'">
              <i class="fas fa-search me-1"></i> Find Friends
            </button>
          </div>
        <% } else { %>
          <div class="row">
            <% friends.forEach(friend => { %>
              <div class="col-md-6 mb-3">
                <div class="card h-100">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="user-avatar-small me-3">
                        <% if (friend.useGravatar && friend.email) { %>
                          <img src="<%= getGravatarUrl(friend.email, 200) %>" alt="Profile Picture" class="profile-image">
                        <% } else if (friend.profilePicture && (friend.profilePicture.startsWith('http') || friend.profilePicture.startsWith('/uploads/') || friend.profilePicture.includes('cloudinary.com'))) { %>
                          <img src="<%= friend.profilePicture %>" alt="Profile Picture" class="profile-image">
                        <% } else { %>
                          <%= (friend.firstName || '').charAt(0) %><%= (friend.lastName || '').charAt(0) %>
                        <% } %>
                      </div>
                      <div class="flex-grow-1">
                        <h6 class="mb-1">
                          <a href="/profile/<%= friend.id %>" class="text-decoration-none">
                            <%= friend.firstName || '' %> <%= friend.lastName || '' %>
                          </a>
                        </h6>
                        <p class="text-muted mb-0 small">@<%= friend.username %></p>
                      </div>
                      <button
                        class="btn btn-outline-danger btn-sm remove-friend-btn"
                        data-friend-id="<%= friend.id %>"
                        data-friend-name="<%= friend.firstName || 'No First Name' %> <%= friend.lastName || 'No Last Name' %>"
                        title="Unfriend"
                      >
                        <i class="fas fa-user-minus"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Close
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="window.location.href='/friends/users'"
        >
          <i class="fas fa-search me-1"></i> Find More Friends
        </button>
      </div>
    </div>
  </div>
</div>