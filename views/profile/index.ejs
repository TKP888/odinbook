<div class="container-fluid profile-page" 
     <% if (typeof profileUser !== 'undefined') { %>
       data-profile-user-id="<%= profileUser.id %>"
     <% } else { %>
       data-profile-user-id="<%= user.id %>"
     <% } %>>
  <div class="row">
    <!-- Profile Header -->
    <div class="col-12 mb-4">
      <div class="card profile-header-card">
        <div class="card-body text-center py-5">
          <div class="profile-avatar mb-4">
            <div class="profile-picture-container">
              <%- include('../partials/user-avatar', { 
                user: (typeof profileUser !== 'undefined') ? profileUser : user, 
                size: 'large',
                id: 'profilePicture',
                showOverlay: (typeof profileUser === 'undefined')
              }) %>
              <% if (typeof profileUser === 'undefined') { %>
                <input type="file" id="profilePictureInput" accept="image/*" class="hidden-input">
              <% } %>
            </div>
          </div>
          <h1 class="profile-name mb-2">
            <% if (typeof profileUser !== 'undefined') { %>
              <%= profileUser.firstName %> <%= profileUser.lastName %>
            <% } else { %>
              <%= user.firstName %> <%= user.lastName %>
            <% } %>
          </h1>
          <p class="profile-username mb-4">
            @<% if (typeof profileUser !== 'undefined') { %><%= profileUser.username %><% } else { %><%= user.username %><% } %>
          </p>
          
          <% if (typeof profileUser === 'undefined') { %>
            <!-- Current user's profile - show edit button -->
            <button class="btn btn-primary btn-lg" onclick="openEditProfileModal()">
              <i class="fas fa-edit me-2"></i>Edit Profile
            </button>
          <% } else { %>
            <!-- Other user's profile - show friend actions -->
            <% if (isFriend) { %>
              <button class="btn btn-success btn-lg me-2" disabled>
                <i class="fas fa-user-check me-2"></i> Friends
              </button>
              <button
                class="btn btn-outline-danger btn-lg"
                onclick="removeFriend('<%= profileUser.id %>', '<%= profileUser.firstName %> <%= profileUser.lastName %>')"
              >
                <i class="fas fa-user-minus me-2"></i> Unfriend
              </button>
            <% } else if (pendingRequest) { %>
              <% if (pendingRequest.senderId === user.id) { %>
                <div class="d-flex gap-3 justify-content-center">
                  <button class="btn btn-secondary btn-lg" disabled>
                    <i class="fas fa-clock me-2"></i> Request Sent
                  </button>
                  <button class="btn btn-outline-danger btn-lg" onclick="cancelFriendRequest('<%= pendingRequest.id %>', '<%= profileUser.firstName %> <%= profileUser.lastName %>')">
                    <i class="fas fa-times me-2"></i> Cancel Request
                  </button>
                </div>
              <% } else { %>
                <div class="btn-group btn-group-lg" role="group">
                  <button class="btn btn-success" onclick="acceptRequest('<%= pendingRequest.id %>')">
                    <i class="fas fa-check me-2"></i> Accept
                  </button>
                  <button class="btn btn-outline-secondary" onclick="declineRequest('<%= pendingRequest.id %>')">
                    <i class="fas fa-times me-2"></i> Decline
                  </button>
                </div>
              <% } %>
            <% } else { %>
              <button class="btn btn-primary btn-lg" onclick="sendFriendRequest('<%= profileUser.id %>', '<%= profileUser.firstName %> <%= profileUser.lastName %>')">
                <i class="fas fa-user-plus me-2"></i> Add Friend
              </button>
            <% } %>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Main Content Row -->
    <div class="col-split" data-is-friend="<%= typeof profileUser !== 'undefined' ? isFriend : 'true' %>">
        <!-- About Section -->
        <div class="card about-section-card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>About
              </h5>
            </div>
            <div class="card-body">
              <!-- Bio Display -->
              <div id="bio-display">
                <% 
                  const displayUser = typeof profileUser !== 'undefined' ? profileUser : user;
                  const displayBio = displayUser.bio;
                %>
                <% if (displayBio) { %>
                  <p class="bio-text mb-3"><%= displayBio %></p>
                  <% if (typeof profileUser === 'undefined') { %>
                    <button class="btn btn-outline-primary btn-sm" onclick="editBio()">
                      <i class="fas fa-edit me-1"></i> Edit Bio
                    </button>
                  <% } %>
                <% } else { %>
                  <p class="text-muted mb-3">No bio added yet.</p>
                  <% if (typeof profileUser === 'undefined') { %>
                    <button class="btn btn-outline-primary btn-sm" onclick="editBio()">
                      <i class="fas fa-plus me-1"></i> Add Bio
                    </button>
                  <% } %>
                <% } %>
              </div>
              
              <!-- Bio Edit Form (hidden by default, only for current user) -->
              <% if (typeof profileUser === 'undefined') { %>
                <div id="bio-edit" class="d-none">
                  <div class="mb-3">
                    <textarea
                      id="bioTextarea"
                      class="form-control"
                      rows="4"
                      placeholder="Tell us about yourself..."
                      maxlength="250"
                    ><%= user.bio || '' %></textarea>
                    <div class="form-text text-end">
                      <span id="bioCharCount"><%= (user.bio || '').length %></span>/250
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm" onclick="saveBio()">
                      <i class="fas fa-save me-1"></i> Save
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="cancelBioEdit()">
                      <i class="fas fa-times me-1"></i> Cancel
                    </button>
                  </div>
                </div>
              <% } %>
              
              <!-- Profile Information -->
              <div class="profile-info mt-4">
                <h6 class="text-muted mb-3">Profile Information</h6>
                
                <!-- Joined Date -->
                <div class="info-item d-flex align-items-center mb-2">
                  <i class="fas fa-calendar-alt me-2 text-muted"></i>
                  <span class="text-muted">Joined </span>
                  <span class="ms-1">
                    <% 
                      const joinedDate = displayUser.createdAt;
                      const options = { year: 'numeric', month: 'long' };
                      const formattedDate = new Date(joinedDate).toLocaleDateString('en-US', options);
                    %>
                    <%= formattedDate %>
                  </span>
                </div>
                
                <!-- Birthday -->
                <% if (displayUser.birthday) { %>
                  <div class="info-item d-flex align-items-center mb-2">
                    <i class="fas fa-birthday-cake me-2 text-muted"></i>
                    <span class="text-muted">Birthday: </span>
                    <span class="ms-1">
                      <% 
                        const birthday = new Date(displayUser.birthday);
                        const birthdayOptions = { month: 'long', day: 'numeric', year: 'numeric' };
                        const formattedBirthday = birthday.toLocaleDateString('en-US', birthdayOptions);
                      %>
                      <%= formattedBirthday %>
                    </span>
                  </div>
                <% } %>
                
                <!-- Gender -->
                <% if (displayUser.gender) { %>
                  <div class="info-item d-flex align-items-center mb-2">
                    <i class="fas fa-user me-2 text-muted"></i>
                    <span class="text-muted">Gender: </span>
                    <span class="ms-1"><%= displayUser.gender %></span>
                  </div>
                <% } %>
                
                <!-- Location -->
                <% if (displayUser.location) { %>
                  <div class="info-item d-flex align-items-center mb-2">
                    <i class="fas fa-map-marker-alt me-2 text-muted"></i>
                    <span class="text-muted">Location: </span>
                    <span class="ms-1"><%= displayUser.location %></span>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
                  <!-- Friends Section -->
        <div class="card friends-section-card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-users me-2"></i>
                <% if (typeof profileUser !== 'undefined') { %>
                  <%= profileUser.firstName %>'s Friends
                <% } else { %>
                  Your Friends
                <% } %>
              </h5>
            </div>
            <div class="card-body">
              <% if (typeof profileUser !== 'undefined' && !isFriend) { %>
              <!-- Not Friends - Show Restricted Message -->
              <div class="text-center text-muted py-4">
                <i class="fas fa-lock fa-3x mb-3 text-warning"></i>
                <h6>Friends are Private</h6>
                <p class="small">Become friends with <%= profileUser.firstName %> to see their friends!</p>
                <div class="mt-3">
                  <small class="text-muted">
                    <i class="fas fa-users me-1"></i>
                    <%= profileUser.firstName %> has friends, but you need to connect first to see them.
                  </small>
                </div>
                <% if (!pendingRequest) { %>
                  <button class="btn btn-primary btn-sm mt-3" onclick="sendFriendRequest('<%= profileUser.id %>', '<%= profileUser.firstName %> <%= profileUser.lastName %>')">
                    <i class="fas fa-user-plus me-1"></i> Send Friend Request
                  </button>
                <% } else if (pendingRequest.senderId === user.id) { %>
                  <div class="d-flex gap-2 mt-3 justify-content-center">
                    <button class="btn btn-secondary btn-sm" disabled>
                      <i class="fas fa-clock me-1"></i> Request Sent
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="cancelFriendRequest('<%= pendingRequest.id %>', '<%= profileUser.firstName %> <%= profileUser.lastName %>')">
                      <i class="fas fa-times me-1"></i> Cancel Request
                    </button>
                  </div>
                <% } else { %>
                  <div class="btn-group btn-group-sm mt-3" role="group">
                    <button class="btn btn-success" onclick="acceptRequest('<%= pendingRequest.id %>')">
                      <i class="fas fa-check me-1"></i> Accept
                    </button>
                    <button class="btn btn-outline-secondary" onclick="declineRequest('<%= pendingRequest.id %>')">
                      <i class="fas fa-times me-1"></i> Decline
                    </button>
                  </div>
                <% } %>
              </div>
              <% } else if (friends.length === 0) { %>
              <div class="text-center text-muted py-4">
                <i class="fas fa-users fa-3x mb-3 text-muted"></i>
                <h6>No friends yet</h6>
                <p class="small">
                  <% if (typeof profileUser === 'undefined') { %>
                    Start connecting with people to build your network!
                  <% } else { %>
                    <%= profileUser.firstName %> hasn't added any friends yet.
                  <% } %>
                </p>
                <% if (typeof profileUser === 'undefined') { %>
                  <button class="btn btn-primary btn-sm" onclick="switchToAllUsers()">
                    <i class="fas fa-search me-1"></i> Find Friends
                  </button>
                <% } %>
              </div>
              <% } else { %>
              <div class="friends-list">
                <% friends.slice(0, 5).forEach(friend => { %>
                <div class="friend-item d-flex align-items-center mb-3 p-3 border rounded">
                  <div class="user-avatar-small me-3">
                    <% if (friend.useGravatar && friend.email) { %>
                      <img src="<%= getGravatarUrl(friend.email, 200) %>" alt="Profile Picture" class="profile-image">
                    <% } else if (friend.profilePicture && (friend.profilePicture.startsWith('http') || friend.profilePicture.startsWith('/uploads/') || friend.profilePicture.includes('cloudinary.com'))) { %>
                      <img src="<%= friend.profilePicture %>" alt="Profile Picture" class="profile-image">
                    <% } else { %>
                      <%= (friend.firstName || '').charAt(0) %><%= (friend.lastName || '').charAt(0) %>
                    <% } %>
                  </div>
                  <div class="flex-grow-1">
                    <h6 class="mb-1 small">
                      <a href="/profile/<%= friend.id %>" class="text-decoration-none">
                        <%= friend.firstName || '' %> <%= friend.lastName || '' %> <%
                        if (!friend.firstName && !friend.lastName) { %>
                        <span class="text-muted">(No name)</span>
                        <% } %>
                      </a>
                    </h6>
                    <p class="text-muted mb-0 small">@<%= friend.username %></p>
                  </div>
                  <% if (typeof profileUser === 'undefined') { %>
                    <button
                      class="btn btn-outline-danger btn-sm remove-friend-btn"
                      data-friend-id="<%= friend.id %>"
                      data-friend-name="<%= friend.firstName || 'No First Name' %> <%= friend.lastName || 'No Last Name' %>"
                      title="Unfriend"
                    >
                      <i class="fas fa-user-minus"></i>
                    </button>
                  <% } %>
                </div>
                <% }); %> <% if (friends.length > 5) { %>
                <div class="text-center mt-3">
                  <button class="btn btn-outline-primary btn-sm" onclick="openViewAllFriendsModal()">
                    <i class="fas fa-eye me-1"></i> View All <%= friends.length %> Friends
                  </button>
                </div>
                <% } %>
              </div>
              <% } %>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
 

    <div class="container-fluid profile-page">

<% if (typeof profileUser === 'undefined') { %>
  <!-- Create Post Form - only show for current user -->
  <div class="col-12 mb-4">
      <div class="card">
                <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-edit me-2"></i>
                  Create New Post
              </h5>
              </div>
              <div class="card-body">
        <div class="d-flex align-items-start">
          <div class="user-avatar-small me-3 flex-shrink-0">
            <% if (user.useGravatar && user.email) { %>
              <img src="<%= getGravatarUrl(user.email, 200) %>" alt="Profile Picture" class="profile-image">
            <% } else if (user.profilePicture && (user.profilePicture.startsWith('http') || user.profilePicture.startsWith('/uploads/') || user.profilePicture.includes('cloudinary.com'))) { %>
              <img src="<%= user.profilePicture %>" alt="Profile Picture" class="profile-image">
            <% } else { %>
              <%= user.firstName.charAt(0) %><%= user.lastName.charAt(0) %>
            <% } %>
          </div>
          <div class="flex-grow-1">
            
            <form id="inlineCreatePostForm" enctype="multipart/form-data">
              <div class="mb-3">
                <textarea
                  id="inlinePostContent"
                  class="form-control"
                  rows="3"
                  placeholder="What's on your mind, <%= user.firstName %>?"
                  maxlength="250"
                ></textarea>
              </div>
              
              <!-- Photo upload section -->
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                  <input
                    type="file"
                    id="inlinePostPhoto"
                    name="photo"
                    accept="image/*"
                    class="form-control form-control-sm hidden-input"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm me-2"
                    onclick="document.getElementById('inlinePostPhoto').click()"
                  >
                    <i class="fas fa-camera me-1"></i> Add Photo
                  </button>
                  <span
                    id="inlinePhotoFileName"
                    class="text-muted small me-2"
                  ></span>
                  <button
                    type="button"
                    id="inlineRemovePhotoBtn"
                    class="btn btn-outline-danger btn-sm hidden-button"
                    onclick="removeInlinePhoto()"
                  >
                    <i class="fas fa-times me-1"></i> Remove
                  </button>
                </div>
                
                <div class="d-flex align-items-center">
                  <small class="text-muted me-3">
                    <span id="inlineCharCount">0</span>/250
                  </small>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="createInlinePost()"
                    id="inlineCreatePostBtn"
                  >
                    <i class="fas fa-paper-plane me-1"></i> Post
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
<% } %>

<!-- Posts Feed -->
<div class="col-12">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-newspaper me-2"></i>
        <% if (typeof profileUser !== 'undefined') { %>
          <%= profileUser.firstName %>'s Posts
        <% } else { %>
          My Posts
        <% } %>
      </h5>
      <button 
        class="btn btn-outline-secondary btn-sm" 
        onclick="refreshPosts()" 
        title="Refresh posts feed"
      >
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
    <div class="card-body">
      <!-- Loading State -->
      <div id="postsLoading" class="text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading posts...</p>
      </div>

      <!-- Posts List -->
      <div id="postsList" class="d-none"></div>

      <!-- Load More Button -->
      <div id="loadMoreContainer" class="text-center mt-3 d-none">
        <button
          id="loadMoreBtn"
          class="btn btn-outline-primary"
          onclick="loadMorePosts()"
        >
          <i
            class="fas fa-spinner fa-spin d-none"
            id="loadMoreSpinner"
          ></i>
          Load More Posts
        </button>
      </div>

      <!-- No Posts -->
      <div id="noPosts" class="text-center text-muted d-none">
        <div class="py-5">
          <% if (typeof profileUser !== 'undefined' && !isFriend) { %>
            <!-- Not Friends - Show Privacy Message -->
            <i class="fas fa-lock fa-3x mb-3 text-warning"></i>
            <h5 class="text-muted">Posts are Private</h5>
            <p class="text-muted">Become friends with <%= profileUser.firstName %> to see their posts!</p>
            <div class="mt-3">
              <small class="text-muted">
                <i class="fas fa-newspaper me-1"></i>
                <%= profileUser.firstName %> has posts, but you need to connect first to see them.
              </small>
            </div>
            <% if (!pendingRequest) { %>
              <button class="btn btn-primary btn-sm mt-3" onclick="sendFriendRequest('<%= profileUser.id %>', '<%= profileUser.firstName %> <%= profileUser.lastName %>')">
                <i class="fas fa-user-plus me-1"></i> Send Friend Request
              </button>
            <% } else if (pendingRequest.senderId === user.id) { %>
              <div class="d-flex gap-2 mt-3 justify-content-center">
                <button class="btn btn-secondary btn-sm" disabled>
                  <i class="fas fa-clock me-1"></i> Request Sent
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="cancelFriendRequest('<%= pendingRequest.id %>', '<%= profileUser.firstName %> <%= profileUser.lastName %>')">
                  <i class="fas fa-times me-1"></i> Cancel Request
                </button>
              </div>
            <% } else { %>
              <div class="btn-group btn-group-sm mt-3" role="group">
                <button class="btn btn-success" onclick="acceptRequest('<%= pendingRequest.id %>')">
                  <i class="fas fa-check me-1"></i> Accept
                </button>
                <button class="btn btn-outline-secondary" onclick="declineRequest('<%= pendingRequest.id %>')">
                  <i class="fas fa-times me-1"></i> Decline
                </button>
              </div>
            <% } %>
          <% } else { %>
            <!-- Friends or Own Profile - Show No Posts Message -->
            <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No posts to show</h5>
            <p class="text-muted">
              <% if (typeof profileUser !== 'undefined') { %>
                <%= profileUser.firstName %> hasn't shared any posts yet.
              <% } else { %>
                You haven't shared any posts yet. Share your thoughts with the world!
              <% } %>
            </p>
            <% if (typeof profileUser === 'undefined') { %>
              <div class="mt-3">
                <button class="btn btn-primary me-2" onclick="openCreatePostModal()">
                  <i class="fas fa-plus"></i> Create Post
                </button>
              </div>
            <% } %>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>
  </div>
</div>

<!-- Unfriend Confirmation Modal -->
<div
  class="modal fade"
  id="unfriendModal"
  tabindex="-1"
  aria-labelledby="unfriendModalLabel"
  aria-hidden="true"

>
          <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="unfriendModalLabel">
          <i class="fas fa-user-minus text-danger me-2"></i>Remove Friend
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to remove <strong id="unfriendUserName"></strong> from your friends?</p>
        <p class="text-muted small mb-0">
          <i class="fas fa-info-circle me-1"></i>
          This action cannot be undone. You'll need to send a new friend request to reconnect.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmUnfriendBtn">
          <i class="fas fa-user-minus me-1"></i>Remove Friend
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Comment Modal -->
<div
  class="modal fade"
  id="editCommentModal"
  tabindex="-1"
  aria-labelledby="editCommentModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCommentModalLabel">Edit Comment</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="editCommentForm">
          <input type="hidden" id="editCommentId" />
          <div class="mb-3">
            <textarea
              id="editCommentContent"
              class="form-control"
              rows="4"
              placeholder="Edit your comment..."
              maxlength="250"
            ></textarea>
            <div class="form-text">
              <span id="editCommentCharCount">0</span>/250
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveEditedComment()"
          id="saveEditCommentBtn"
        >
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Likes Modal -->
<div
  class="modal fade"
  id="likesModal"
  tabindex="-1"
  aria-labelledby="likesModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="likesModalLabel">People who liked this post</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="likesList">
          <!-- Likes will be populated here -->
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="/js/profile.js"></script>

<script>
// Initialize posts using dashboard logic
document.addEventListener('DOMContentLoaded', function() {
  // Call the loadPosts function to load posts from backend
  if (typeof loadPosts === 'function') {
    console.log('Profile page loaded with dashboard logic');
    // Load posts from backend
    loadPosts(true);
  } else {
    console.error('loadPosts function not found');
  }
});
</script>

<!-- Create Post Modal -->
<div
  class="modal fade"
  id="createPostModal"
  tabindex="-1"
  aria-labelledby="createPostModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createPostModalLabel">
          Create New Post
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="createPostForm" enctype="multipart/form-data">
          <div class="mb-3">
            <textarea
              id="postContent"
              class="form-control"
              rows="6"
              placeholder="What's on your mind, <%= user.firstName.charAt(0) %>?"
              maxlength="250"
            ></textarea>
            
            <!-- Photo upload section -->
            <div class="mt-2">
              <input
                type="file"
                id="postPhoto"
                name="photo"
                accept="image/*"
                class="form-control form-control-sm hidden-input"
              />
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm me-2"
                onclick="document.getElementById('postPhoto').click()"
              >
                <i class="fas fa-camera"></i> Add Photo
              </button>
              <span
                id="photoFileName"
                class="text-muted small"
              ></span>
              <button
                type="button"
                id="removePhotoBtn"
                class="btn btn-outline-danger btn-sm ms-2 hidden-button"
                onclick="removePhoto()"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="form-text"><span id="charCount">0</span>/250</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="createPost()"
          id="createPostBtn"
        >
          Post
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Post Modal -->
<div
  class="modal fade"
  id="editPostModal"
  tabindex="-1"
  aria-labelledby="editPostModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPostModalLabel">Edit Post</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="editPostForm">
          <input type="hidden" id="editPostId" />
          <div class="mb-3">
            <textarea
              id="editPostContent"
              class="form-control"
              rows="6"
              placeholder="What's on your mind?"
              maxlength="1000"
            ></textarea>
            <div class="form-text">
              <span id="editCharCount">0</span>/250
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveEditedPost()"
          id="saveEditPostBtn"
        >
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Likes Modal -->
<div
  class="modal fade"
  id="likesModal"
  tabindex="-1"
  aria-labelledby="likesModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="likesModalLabel">
          People who liked this post
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="likesList">
          <!-- Likes will be populated here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div
  class="modal fade"
  id="editProfileModal"
  tabindex="-1"
  aria-labelledby="editProfileModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="editProfileForm">
          <div class="mb-3">
            <label for="editFirstName" class="form-label">First Name</label>
            <input
              type="text"
              class="form-control"
              id="editFirstName"
              value="<%= user.firstName %>"
              maxlength="50"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editLastName" class="form-label">Last Name</label>
            <input
              type="text"
              class="form-control"
              id="editLastName"
              value="<%= user.lastName %>"
              maxlength="50"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editUsername" class="form-label">Username</label>
            <input
              type="text"
              class="form-control"
              id="editUsername"
              value="<%= user.username %>"
              maxlength="30"
              minlength="3"
              required
            />
            <div class="form-text">Username must be between 3 and 30 characters</div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editBirthday" class="form-label">Birthday (Optional)</label>
              <input
                type="date"
                class="form-control"
                id="editBirthday"
                value="<%= user.birthday ? user.birthday.toISOString().split('T')[0] : '' %>"
              />
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="editGender" class="form-label">Gender (Optional)</label>
              <select class="form-control" id="editGender">
                <option value="">Select gender</option>
                <option value="Male" <%= user.gender === 'Male' ? 'selected' : '' %>>Male</option>
                <option value="Female" <%= user.gender === 'Female' ? 'selected' : '' %>>Female</option>
                <option value="Other" <%= user.gender === 'Other' ? 'selected' : '' %>>Other</option>
                <option value="Prefer not to say" <%= user.gender === 'Prefer not to say' ? 'selected' : '' %>>Prefer not to say</option>
              </select>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="editLocation" class="form-label">Location (Optional)</label>
            <input
              type="text"
              class="form-control"
              id="editLocation"
              value="<%= user.location || '' %>"
              placeholder="City, Country (e.g., London, UK)"
              maxlength="100"
              autocomplete="off"
            />
          </div>
          

        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveProfileChanges()"
          id="saveProfileBtn"
        >
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View All Friends Modal -->
<div
  class="modal fade"
  id="viewAllFriendsModal"
  tabindex="-1"
  aria-labelledby="viewAllFriendsModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewAllFriendsModalLabel">
          <i class="fas fa-users me-2"></i>All Friends (<%= friends.length %>)
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <% if (friends.length === 0) { %>
          <div class="text-center text-muted py-4">
            <i class="fas fa-users fa-3x mb-3 text-muted"></i>
            <h6>No friends yet</h6>
            <p class="text-muted">Start connecting with people to build your network!</p>
            <button class="btn btn-primary btn-sm" onclick="window.location.href='/friends/users'">
              <i class="fas fa-search me-1"></i> Find Friends
            </button>
          </div>
        <% } else { %>
          <div class="row">
            <% friends.forEach(friend => { %>
              <div class="col-md-6 mb-3">
                <div class="card h-100">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="user-avatar-small me-3">
                        <% if (friend.useGravatar && friend.email) { %>
                          <img src="<%= getGravatarUrl(friend.email, 200) %>" alt="Profile Picture" class="profile-image">
                        <% } else if (friend.profilePicture && (friend.profilePicture.startsWith('http') || friend.profilePicture.startsWith('/uploads/') || friend.profilePicture.includes('cloudinary.com'))) { %>
                          <img src="<%= friend.profilePicture %>" alt="Profile Picture" class="profile-image">
                        <% } else { %>
                          <%= (friend.firstName || '').charAt(0) %><%= (friend.lastName || '').charAt(0) %>
                        <% } %>
                      </div>
                      <div class="flex-grow-1">
                        <h6 class="mb-1">
                          <a href="/profile/<%= friend.id %>" class="text-decoration-none">
                            <%= friend.firstName || '' %> <%= friend.lastName || '' %>
                          </a>
                        </h6>
                        <p class="text-muted mb-0 small">@<%= friend.username %></p>
                      </div>
                      <button
                        class="btn btn-outline-danger btn-sm remove-friend-btn"
                        data-friend-id="<%= friend.id %>"
                        data-friend-name="<%= friend.firstName || 'No First Name' %> <%= friend.lastName || 'No Last Name' %>"
                        title="Unfriend"
                      >
                        <i class="fas fa-user-minus"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Close
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="window.location.href='/friends/users'"
        >
          <i class="fas fa-search me-1"></i> Find More Friends
        </button>
      </div>
    </div>
  </div>
</div>