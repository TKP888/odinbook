<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <h2>Users</h2>

      <!-- Search Bar -->
      <div class="mb-3">
        <input
          type="text"
          id="searchInput"
          class="form-control"
          placeholder="Search users..."
        />
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="userTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="all-tab"
            data-bs-toggle="tab"
            data-bs-target="#all"
            type="button"
            role="tab"
          >
            All Users
            <span class="badge bg-primary ms-1" id="allUsersCount">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="friends-tab"
            data-bs-toggle="tab"
            data-bs-target="#friends"
            type="button"
            role="tab"
          >
            Friends
            <span class="badge bg-success ms-1" id="friendsCount">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="requests-tab"
            data-bs-toggle="tab"
            data-bs-target="#requests"
            type="button"
            role="tab"
          >
            Sent Requests
            <span class="badge bg-warning ms-1" id="requestCount">0</span>
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="userTabsContent">
        <!-- All Users Tab -->
        <div class="tab-pane fade show active" id="all" role="tabpanel">
          <div id="allUsersList" class="row">
            <!-- Users will be loaded here -->
          </div>
        </div>

        <!-- Friends Tab -->
        <div class="tab-pane fade" id="friends" role="tabpanel">
          <div id="friendsList" class="row">
            <!-- Friends will be loaded here -->
          </div>
        </div>

        <!-- Sent Requests Tab -->
        <div class="tab-pane fade" id="requests" role="tabpanel">
          <div id="requestsList" class="row">
            <!-- Sent requests will be loaded here -->
          </div>
          <div id="noRequests" class="text-center text-muted d-none">
            <div class="py-5">
              <i class="fas fa-paper-plane fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">
                You haven't sent any friend requests yet
              </h5>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/js/friends.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let allUsers = [];
    let friends = [];
    let requests = [];

    // Check URL parameters for tab switching
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get("tab");

    // Load users on page load
    loadUsers();

    // Switch to the correct tab if specified in URL
    if (activeTab) {
      setTimeout(() => {
        switchToTab(activeTab);
      }, 100); // Small delay to ensure tabs are loaded
    }

    // Function to switch tabs
    function switchToTab(tabName) {
      // Remove active class from all tabs and content
      document.querySelectorAll(".nav-link").forEach((tab) => {
        tab.classList.remove("active");
      });
      document.querySelectorAll(".tab-pane").forEach((content) => {
        content.classList.remove("show", "active");
      });

      // Activate the specified tab
      const targetTab = document.getElementById(`${tabName}-tab`);
      const targetContent = document.getElementById(tabName);

      if (targetTab && targetContent) {
        targetTab.classList.add("active");
        targetContent.classList.add("show", "active");
      }
    }

    // Search functionality
    document
      .getElementById("searchInput")
      .addEventListener("input", function (e) {
        const searchTerm = e.target.value.toLowerCase();
        filterUsers(searchTerm);
      });

    async function loadUsers() {
      try {
        const response = await fetch("/friends/users", {
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            Accept: "application/json",
          },
        });
        if (!response.ok) throw new Error("Failed to fetch users");

        allUsers = await response.json();

        // Categorize users
        friends = allUsers.filter((user) => user.status === "friend");
        requests = allUsers.filter((user) => user.status === "request_sent");

        // Render all tabs
        renderUsers("allUsersList", allUsers);
        renderUsers("friendsList", friends);
        renderRequests("requestsList", requests);

        // Update all counts
        updateAllCounts();
      } catch (error) {
        console.error("Error loading users:", error);
        showError("Failed to load users. Please try again.");
      }
    }

    function filterUsers(searchTerm) {
      const filtered = allUsers.filter(
        (user) =>
          user.username.toLowerCase().includes(searchTerm) ||
          (user.firstName &&
            user.firstName.toLowerCase().includes(searchTerm)) ||
          (user.lastName && user.lastName.toLowerCase().includes(searchTerm))
      );
      renderUsers("allUsersList", filtered);
    }

    function renderUsers(containerId, users) {
      const container = document.getElementById(containerId);
      if (!container) return;

      if (users.length === 0) {
        container.innerHTML =
          '<div class="col-12"><p class="text-muted">No users found.</p></div>';
        return;
      }

      container.innerHTML = users
        .map(
          (user) => `
      <div class="col-md-6 col-lg-4 mb-3" data-user-id="${user.id}">
        <div class="card user-card ${
          user.status === "friend" ? "clickable-friend-card" : ""
        }" data-username="${user.username}" data-is-friend="${
            user.status === "friend"
          }">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="user-avatar-large me-3">
                ${getUserAvatar(user)}
              </div>
              <div class="user-info">
                <h6 class="mb-0 user-name">${
                  user.firstName || user.lastName
                    ? `${user.firstName || ""} ${user.lastName || ""}`
                    : user.username
                }</h6>
                <p class="text-muted mb-0 small username">@${user.username}</p>
              </div>
            </div>
            <div id="friend-actions-${user.id}">
              ${getActionButton(user)}
            </div>
          </div>
        </div>
      </div>
    `
        )
        .join("");

      // Add event listeners for buttons
      // addButtonEventListeners(); // This line is removed as per the edit hint

      // Add click event listeners for friend cards (in all tabs)
      const friendCards = container.querySelectorAll(".clickable-friend-card");
      friendCards.forEach((card) => {
        card.addEventListener("click", function (e) {
          // Don't navigate if clicking on a button
          if (e.target.closest("button")) {
            return;
          }

          const username = this.getAttribute("data-username");
          if (username) {
            navigateToProfile(username);
          }
        });
      });

      // Debug: Log button elements to see if they're being rendered correctly
      if (containerId === "allUsersList") {
        const addFriendButtons = container.querySelectorAll(".add-friend-btn");
        console.log(
          `Found ${addFriendButtons.length} add-friend buttons in ${containerId}:`,
          addFriendButtons
        );
        addFriendButtons.forEach((btn) => {
          console.log("Button data:", {
            id: btn.id,
            userId: btn.getAttribute("data-user-id"),
            userName: btn.getAttribute("data-user-name"),
          });
        });
      }
    }

    function getUserAvatar(user) {
      if (user.gravatarUrl) {
        return `<img src="${user.gravatarUrl}" alt="${user.username}" class="rounded-circle profile-image" style="width: 100%; height: 100%; object-fit: cover;">`;
      }

      if (user.profilePicture) {
        return `<img src="${user.profilePicture}" alt="${user.username}" class="rounded-circle profile-image" style="width: 100%; height: 100%; object-fit: cover;">`;
      } else {
        const firstName = user.firstName || "";
        const lastName = user.lastName || "";
        const initials = (
          firstName.charAt(0) + lastName.charAt(0)
        ).toUpperCase();
        return `<div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 100%; height: 100%;">${initials}</div>`;
      }
    }

    function renderRequests(containerId, requests) {
      const container = document.getElementById(containerId);
      if (!container) return;

      if (requests.length === 0) {
        container.innerHTML = "";
        document.getElementById("noRequests").classList.remove("d-none");
        return;
      }

      document.getElementById("noRequests").classList.add("d-none");
      container.innerHTML = requests
        .map(
          (user) => `
      <div class="col-md-6 col-lg-4 mb-3" data-user-id="${user.id}">
        <div class="card user-card">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="user-avatar-large me-3">
                ${getUserAvatar(user)}
              </div>
              <div class="user-info">
                <h6 class="mb-0 user-name">${
                  user.firstName || user.lastName
                    ? `${user.firstName || ""} ${user.lastName || ""}`
                    : user.username
                }</h6>
                <p class="text-muted mb-0 small username">@${user.username}</p>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">Request sent ${formatRequestDate(
                user.requestSentAt || user.createdAt
              )}</small>
              <div id="friend-actions-${user.id}">
                ${getActionButton(user)}
              </div>
            </div>
          </div>
        </div>
      </div>
    `
        )
        .join("");

      // Add event listeners for request buttons
      // addRequestButtonEventListeners(); // This line is removed as per the edit hint
    }

    function getActionButton(user) {
      switch (user.status) {
        case "friend":
          return `<button class="btn btn-outline-danger btn-sm remove-friend-btn" data-user-id="${
            user.id
          }" data-user-name="${user.firstName || user.lastName ? `${user.firstName || ""} ${user.lastName || ""}` : user.username}">
            <i class="fas fa-user-minus"></i> Remove Friend
          </button>`;
        case "request_sent":
          return `<button class="btn btn-outline-secondary btn-sm cancel-request-btn" id="cancel-request-btn-${
            user.id
          }" data-user-id="${user.id}" data-user-name="${user.firstName || user.lastName ? `${user.firstName || ""} ${user.lastName || ""}` : user.username}" data-request-id="${user.requestId}">
            <i class="fas fa-times"></i> Cancel Request
          </button>`;
        case "request_received":
          return `<div class="d-flex gap-2">
            <button class="btn btn-success btn-sm accept-request-btn" data-request-id="${user.requestId}">
              <i class="fas fa-check"></i> Accept
            </button>
            <button class="btn btn-danger btn-sm decline-request-btn" data-request-id="${user.requestId}">
              <i class="fas fa-times"></i> Decline
            </button>
          </div>`;
        default:
          return `<button class="btn btn-primary btn-sm add-friend-btn" id="add-friend-btn-${
            user.id
          }" data-user-id="${user.id}" data-user-name="${user.firstName || user.lastName ? `${user.firstName || ""} ${user.lastName || ""}` : user.username}">
            <i class="fas fa-user-plus"></i> Add Friend
          </button>`;
      }
    }

    // Event delegation is handled by friends.js - no need to duplicate here

    // Remove the old event listener functions since we're using event delegation
    // function addButtonEventListeners() { ... }
    // function addRequestButtonEventListeners() { ... }

    function updateAllCounts() {
      const allUsersCountBadge = document.getElementById("allUsersCount");
      const friendsCountBadge = document.getElementById("friendsCount");
      const requestCountBadge = document.getElementById("requestCount");

      allUsersCountBadge.textContent = allUsers.length;
      friendsCountBadge.textContent = friends.length;
      requestCountBadge.textContent = requests.length;

      if (allUsers.length > 0) {
        allUsersCountBadge.classList.remove("d-none");
      } else {
        allUsersCountBadge.classList.add("d-none");
      }

      if (friends.length > 0) {
        friendsCountBadge.classList.remove("d-none");
      } else {
        friendsCountBadge.classList.add("d-none");
      }

      if (requests.length > 0) {
        requestCountBadge.classList.remove("d-none");
      } else {
        requestCountBadge.classList.add("d-none");
      }
    }

    // Function to refresh counts after friend status changes
    function refreshCounts() {
      // Re-categorize users based on current status
      friends = allUsers.filter((user) => user.status === "friend");
      requests = allUsers.filter((user) => user.status === "request_sent");

      // Update the display
      updateAllCounts();
    }

    // Make refreshCounts available globally so friends.js can call it
    window.refreshCounts = refreshCounts;

    // Function to navigate to user profile
    function navigateToProfile(username) {
      // Find the user object to get the ID
      const user = allUsers.find((u) => u.username === username);
      if (user) {
        window.location.href = `/profile/${user.id}`;
      }
    }

    // Make navigateToProfile available globally so onclick handlers can call it
    window.navigateToProfile = navigateToProfile;

    // Function to format request date
    function formatRequestDate(dateString) {
      if (!dateString) return "recently";

      const date = new Date(dateString);
      if (isNaN(date.getTime())) return "recently";

      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays === 1) return "yesterday";
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks ago`;
      if (diffDays < 365) return `${Math.ceil(diffDays / 30)} months ago`;

      return date.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      });
    }

    function showError(message) {
      // Create error alert
      const errorAlert = document.createElement("div");
      errorAlert.className = "alert alert-danger alert-dismissible fade show";
      errorAlert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;

      // Insert at the top of the container
      const container = document.querySelector(".container");
      container.insertBefore(errorAlert, container.firstChild);
    }
  });
</script>
